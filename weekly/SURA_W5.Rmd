---
title: "Week 5-6: HDBSCAN Clustering" 
subtitle: "SURA 2022"
author: "Shih-Ting (Cindy) Huang"
date: '2022-06-29'
output: html_document
---

```{r setup, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)

library(tidyverse)
library(dplyr)
library(leaflet)
library(sf)
library(mapview)
library(ggplot2)
library(RColorBrewer)
library(dbscan)
library(leafpop)
```


```{r load-data, echo=FALSE}
# Run the script to preprocess fire datasets to include information on time, location, and FRP
url <- "https://raw.githubusercontent.com/cindyellow/SURA-2022/main/preprocess_fire_kml.R"
if (!file.exists("../preprocess_fire_kml.R"))
  download.file(url, destfile = "../preprocess_fire_kml.R")
source("../preprocess_fire_kml.R")
```


## HDBSCAN 

```{r}
# Try HDBSCAN for 11/08/2018
one <- in_cali %>%
  filter(date == "2018-11-08")

coords <- as.tibble(st_coordinates(one$geometry))
```


### Finding the best parameters

There are several metrics for evaluating the quality of clusters. The following are some common ones and an evaluation:

- CDbw: considers multiple representative points per cluster, but it means that we have to introduce a parameter for defining the number of points
  - cohesion: within-cluster density change
  - compactness: average within-cluster density
  - separation: inter-cluster density
  - CDbw index: relative validity index that takes into consideration all of the aforementioned metrics
- DBCV: evaluates clusters by comparing the highest density between clusters and the lowest density in clusters

Reference: 
Moulavi, Davoud & A Jaskowiak, Pablo & Campello, Ricardo & Zimek, Arthur & Sander, Joerg. (2014). Density-Based Clustering Validation. 10.1137/1.9781611973440.96. 
[URL](https://www.researchgate.net/publication/260333211_Density-Based_Clustering_Validation)

[A density-based cluster validity approach using multi-representatives](https://www.sciencedirect.com/science/article/pii/S0167865508000020)

Currently, CDbw is used to compare the clusters because there is a well-implemented package in R for it. 
```{r}
library(fpc)

# Compare CDBW index for all possible clusters
minpts <- seq(5,100, by=5)
scores <- c()
for (x in minpts){
  cl <- hdbscan(coords, minPts = x)
  scores <- c(scores, cdbw(coords, cl$cluster)$cdbw)
}

best_param <- minpts[which.max(scores)]
```

```{r}
# Create hdbscan object with best minPts
cl <- hdbscan(coords, minPts = best_param)
plot(coords, col=cl$cluster+1, pch=20)
```



## Cluster Visualization

In HDBSCAN, clusters are arbitrarily shape. Hence, we cannot obtain a cluster "centroid" effectively.


```{r}
# Add cluster assignments to the original dataset
one <- one %>%
  mutate(cluster = cl$cluster) %>%
  filter(cluster != 0) # Eliminates noise points

one <- st_as_sf(one)
```

```{r}
length(unique(one$cluster))
```

```{r}
mapview(one, zcol = "cluster", label=FALSE, legend=FALSE, layer.name = 'cluster', 
        popup = popupTable(
              one,
              zcol = c(
                "start_time",
                "method_of_detect",
                "satellite",
                "cluster"
                ),
              feature.id = FALSE
              )
        )
```

## Cluster FRP: Summary

```{r}
# Group by cluster
cluster_info <- as.tibble(one) %>%
  group_by(cluster) %>%
  summarise(frp_avg = mean(frp, na.rm=TRUE),
            frp_vars = var(frp, na.rm=TRUE)) 
# Assign them with average
one <- as.tibble(one) %>%
  inner_join(cluster_info, by="cluster")
```

```{r}
# Display the average FRP for each cluster and the variance
cluster_info
```


