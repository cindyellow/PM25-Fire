---
title: "SURA_W3"
author: "Shih-Ting (Cindy) Huang"
date: '2022-06-11'
output: html_document
---

```{r setup, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)

library(tidyverse)
library(dplyr)
library(leaflet)
library(sf)
library(mapview)
library(rgdal)
library(shiny)
```

```{r}
# Read the text file
nov8 <- st_read("data/fire/hms20181107.txt")
```

```{r}
cal_bound <- st_read("ca-state-boundary/CA_State_TIGER2016.shp")

# Convert to the same coordinate system as HMS
cal_bound <- cal_bound %>%
  st_set_crs(3857) %>% 
  st_transform(4326)
```

```{r}
# Get an array of whether each observation is in California
in_bound <- lengths(st_intersects(nov8, cal_bound))>0
```

```{r}
# Get subset with indexing
# https://gis.stackexchange.com/questions/394954/r-using-st-intersects-to-classify-points-inside-outside-and-within-a-buffer
in_cali <- nov8[in_bound,]
```

# Figure out the smoke layer thing

```{r}
library(sf)
library(xml2)
library(tidyverse)
```


```{r}
# Read light, medium, heavy separately
smoke_light <- st_read("data/smoke/smoke20220501.kml", layer="Smoke (Light)")
smoke_light <- as.data.frame(smoke_light)

smoke_med <- st_read("data/smoke/smoke20220501.kml", layer="Smoke (Medium)")
smoke_med <- as.data.frame(smoke_med)

smoke_heavy <- st_read("data/smoke/smoke20220501.kml", layer="Smoke (Heavy)")
smoke_heavy <- as.data.frame(smoke_heavy)
```

```{r}
smoke_light <- smoke_light %>%
  # Remove prefix
  mutate(Description = gsub('Smoke Attributes: Start Time: ', '', Description)) %>%
  mutate(Description = gsub('[a-zA-Z]*: ', ',', Description)) %>%
  separate(., col=Description, 
           into = c('start_time', 'end_time', 'density', 'satellite'),
           sep = ',') 
  
```

```{r}
smoke_light_mod <- smoke_light %>% 
  mutate(start_time = (str_remove_all(start_time,"[a-zA-Z]")),
         end_time = (str_remove_all(end_time,"[a-zA-Z]"))) %>%
  separate(., col=start_time, 
           into=c('start_date', 'st'),
           sep=' ') %>%
  separate(., col=end_time, 
           into=c('end_date','et'),
           sep=' ') %>%
  mutate( st = substr(as.POSIXct(sprintf("%04.0f", as.integer(st)), format='%H%M'), 12, 16),
          et = substr(as.POSIXct(sprintf("%04.0f", as.integer(et)), format='%H%M'), 12, 16),
          start_time = as.POSIXct(paste(start_date, st),
                            format = "%m/%d/%Y %H:%M"),
         end_time = as.POSIXct(paste(end_date, et),
                            format = "%m/%d/%Y %H:%M")) %>%
  rowid_to_column("index")%>%
  select(-start_date, -end_date, -st, -et,-Name)
```













